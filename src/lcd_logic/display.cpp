#include "display.h"
#include "lcd_controller.h"

namespace lcd
{
	auto init_default_font = []()->std::array<std::array<char, 8>, 255> {
		std::array<std::array<char, 8>, 255> result = { 0, 0, 0, 0, 0, 0, 0, 0 };
		char data[] = {
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x08, 0x0c, 0x0e, 0x0f, 0x0e, 0x0c, 0x08,
			0x00, 0x02, 0x06, 0x0e, 0x1e, 0x0e, 0x06, 0x02,
			0x00, 0x00, 0x09, 0x12, 0x1b, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x1b, 0x09, 0x12, 0x00, 0x00, 0x00,
			0x00, 0x04, 0x0e, 0x1f, 0x00, 0x04, 0x0e, 0x1f,
			0x00, 0x1f, 0x0e, 0x04, 0x00, 0x1f, 0x0e, 0x04,
			0x00, 0x00, 0x0e, 0x1f, 0x1f, 0x1f, 0x0e, 0x00,
			0x00, 0x01, 0x01, 0x05, 0x09, 0x1f, 0x08, 0x04,
			0x00, 0x04, 0x0e, 0x15, 0x04, 0x04, 0x04, 0x04,
			0x00, 0x04, 0x04, 0x04, 0x04, 0x15, 0x0e, 0x04,
			0x00, 0x00, 0x04, 0x02, 0x1f, 0x02, 0x04, 0x00,
			0x00, 0x00, 0x04, 0x08, 0x1f, 0x08, 0x04, 0x00,
			0x00, 0x02, 0x04, 0x08, 0x04, 0x02, 0x00, 0x1f,
			0x00, 0x08, 0x04, 0x02, 0x04, 0x08, 0x00, 0x1f,
			0x00, 0x00, 0x04, 0x04, 0x0e, 0x0e, 0x1f, 0x00,
			0x00, 0x00, 0x1f, 0x0e, 0x0e, 0x04, 0x04, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x04,
			0x00, 0x00, 0x0a, 0x0a, 0x0a, 0x00, 0x00, 0x00,
			0x00, 0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a,
			0x00, 0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04,
			0x00, 0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03,
			0x00, 0x0c, 0x12, 0x14, 0x08, 0x15, 0x12, 0x0d,
			0x00, 0x0c, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02,
			0x00, 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08,
			0x00, 0x00, 0x04, 0x15, 0x0e, 0x15, 0x04, 0x00,
			0x00, 0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x04, 0x08,
			0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c,
			0x00, 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x00,
			0x00, 0x0e, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0e,
			0x00, 0x04, 0x0c, 0x04, 0x04, 0x04, 0x04, 0x0e,
			0x00, 0x0e, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1f,
			0x00, 0x1f, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0e,
			0x00, 0x02, 0x06, 0x0a, 0x12, 0x1f, 0x02, 0x02,
			0x00, 0x1f, 0x10, 0x1e, 0x01, 0x01, 0x11, 0x0e,
			0x00, 0x06, 0x08, 0x10, 0x1e, 0x11, 0x11, 0x0e,
			0x00, 0x1f, 0x11, 0x01, 0x02, 0x04, 0x04, 0x04,
			0x00, 0x0e, 0x11, 0x11, 0x0e, 0x11, 0x11, 0x0e,
			0x00, 0x0e, 0x11, 0x11, 0x0f, 0x01, 0x02, 0x0c,
			0x00, 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x0c, 0x00,
			0x00, 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08,
			0x00, 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02,
			0x00, 0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00,
			0x00, 0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08,
			0x00, 0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04,
			0x00, 0x0e, 0x11, 0x01, 0x0d, 0x15, 0x15, 0x0e,
			0x00, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11,
			0x00, 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e,
			0x00, 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e,
			0x00, 0x1c, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1c,
			0x00, 0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x1f,
			0x00, 0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x10,
			0x00, 0x0e, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0f,
			0x00, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11,
			0x00, 0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e,
			0x00, 0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c,
			0x00, 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11,
			0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f,
			0x00, 0x11, 0x1b, 0x15, 0x15, 0x11, 0x11, 0x11,
			0x00, 0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11,
			0x00, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e,
			0x00, 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10,
			0x00, 0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d,
			0x00, 0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11,
			0x00, 0x0e, 0x11, 0x10, 0x0e, 0x01, 0x11, 0x0e,
			0x00, 0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
			0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e,
			0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04,
			0x00, 0x11, 0x11, 0x11, 0x15, 0x15, 0x15, 0x0a,
			0x00, 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11,
			0x00, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04,
			0x00, 0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f,
			0x00, 0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e,
			0x00, 0x00, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00,
			0x00, 0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e,
			0x00, 0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f,
			0x00, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x0e, 0x01, 0x0f, 0x11, 0x0f,
			0x00, 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x1e,
			0x00, 0x00, 0x00, 0x0e, 0x10, 0x10, 0x11, 0x0e,
			0x00, 0x01, 0x01, 0x0d, 0x13, 0x11, 0x11, 0x0f,
			0x00, 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0e,
			0x00, 0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08,
			0x00, 0x00, 0x00, 0x0f, 0x11, 0x0f, 0x01, 0x0e,
			0x00, 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x11,
			0x00, 0x04, 0x00, 0x04, 0x0c, 0x04, 0x04, 0x0e,
			0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0c,
			0x00, 0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12,
			0x00, 0x0c, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e,
			0x00, 0x00, 0x00, 0x1a, 0x15, 0x15, 0x15, 0x15,
			0x00, 0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11,
			0x00, 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e,
			0x00, 0x00, 0x00, 0x1e, 0x11, 0x1e, 0x10, 0x10,
			0x00, 0x00, 0x00, 0x0d, 0x13, 0x0f, 0x01, 0x01,
			0x00, 0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10,
			0x00, 0x00, 0x00, 0x0e, 0x10, 0x0e, 0x01, 0x1e,
			0x00, 0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06,
			0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d,
			0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04,
			0x00, 0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0a,
			0x00, 0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11,
			0x00, 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x0e,
			0x00, 0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f,
			0x00, 0x02, 0x04, 0x04, 0x08, 0x04, 0x04, 0x02,
			0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
			0x00, 0x08, 0x04, 0x04, 0x02, 0x04, 0x04, 0x08,
			0x00, 0x00, 0x00, 0x00, 0x0d, 0x12, 0x00, 0x00,
			0x00, 0x04, 0x0a, 0x11, 0x11, 0x11, 0x1f, 0x00,
			0x00, 0x1f, 0x11, 0x10, 0x1e, 0x11, 0x11, 0x1e,
			0x0f, 0x05, 0x05, 0x09, 0x11, 0x1f, 0x11, 0x11,
			0x00, 0x15, 0x15, 0x15, 0x0e, 0x15, 0x15, 0x15,
			0x00, 0x1e, 0x01, 0x01, 0x06, 0x01, 0x01, 0x1e,
			0x00, 0x11, 0x11, 0x13, 0x15, 0x19, 0x11, 0x11,
			0x0a, 0x04, 0x11, 0x11, 0x13, 0x15, 0x19, 0x11,
			0x00, 0x0f, 0x05, 0x05, 0x05, 0x05, 0x15, 0x09,
			0x00, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
			0x00, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x08, 0x10,
			0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1f, 0x01,
			0x00, 0x11, 0x11, 0x11, 0x0f, 0x01, 0x01, 0x01,
			0x00, 0x00, 0x15, 0x15, 0x15, 0x15, 0x15, 0x1f,
			0x00, 0x15, 0x15, 0x15, 0x15, 0x15, 0x1f, 0x01,
			0x00, 0x18, 0x08, 0x08, 0x0e, 0x09, 0x09, 0x0e,
			0x00, 0x11, 0x11, 0x11, 0x19, 0x15, 0x15, 0x19,
			0x00, 0x0e, 0x11, 0x05, 0x0b, 0x01, 0x11, 0x0e,
			0x00, 0x00, 0x00, 0x09, 0x15, 0x12, 0x12, 0x0d,
			0x00, 0x04, 0x06, 0x05, 0x05, 0x04, 0x1c, 0x1c,
			0x00, 0x1f, 0x11, 0x10, 0x10, 0x10, 0x10, 0x10,
			0x00, 0x00, 0x00, 0x1f, 0x0a, 0x0a, 0x0a, 0x13,
			0x00, 0x3f, 0x20, 0x10, 0x08, 0x10, 0x20, 0x3f,
			0x00, 0x00, 0x00, 0x0f, 0x12, 0x12, 0x12, 0x0c,
			0x06, 0x05, 0x07, 0x05, 0x05, 0x1d, 0x1b, 0x03,
			0x00, 0x00, 0x01, 0x0e, 0x14, 0x04, 0x04, 0x02,
			0x00, 0x04, 0x0e, 0x0e, 0x0e, 0x1f, 0x04, 0x00,
			0x00, 0x0e, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x0e,
			0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0a, 0x1b,
			0x00, 0x06, 0x09, 0x04, 0x0a, 0x11, 0x11, 0x0e,
			0x00, 0x00, 0x00, 0x0b, 0x15, 0x1a, 0x00, 0x00,
			0x00, 0x00, 0x0a, 0x1f, 0x1f, 0x1f, 0x0e, 0x04,
			0x00, 0x00, 0x00, 0x0e, 0x10, 0x0c, 0x11, 0x0e,
			0x00, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11
		};
		std::memcpy(result.data(), data, sizeof(data));
		return result;
	};

	std::array<std::array<char, 8>, 255> default_font = init_default_font();

	display::display(size_t width, size_t height)
		: m_width(width)
		, m_height(height)
		, m_font(default_font)
		, m_visual(width* height + 1)
	{}

	void display::setup_font(std::array<std::array<char, 8>, 255> font)
	{
		m_font = font;
		update();
	}

	std::array<std::array<char, 8>, 255> const& display::font() const
	{
		return m_font;
	}

	void display::update() {}

	char& display::symbol_at(size_t row, size_t column)
	{
		if (row < 0 || row > m_height || column < 0 || column > m_width)
			return m_controller->symbol_at_ddram(0x00);

		return m_controller->symbol_at_ddram(row % 2 * 0x40 + row / 2 * m_width + column);
	}

	const char& display::symbol_at(size_t row, size_t column) const
	{
		if (row < 0 || row > m_height || column < 0 || column > m_width)
			return m_controller->symbol_at_ddram(0x00);

		return m_controller->symbol_at_ddram(row % 2 * 0x40 + row / 2 * m_width + column);
	}

	void display::set_controller(lcd_controller_ptr controller)
	{
		m_controller = controller;
		controller->register_for_updates(
			[=]()
			{
				update();
			}
		);
	}

#pragma region i_character_data

	void display::set_char_at(size_t row, size_t column, char ch)
	{
		symbol_at(row, column) = ch;
		update();
	}

	char display::get_char_at(size_t row, size_t column) const
	{
		return symbol_at(row, column);
	}

#pragma endregion i_character_data
}
